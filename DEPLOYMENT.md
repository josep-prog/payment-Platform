# MoMo Payment Verification System - Deployment Guide\n\n## Overview\n\nThis guide covers the complete deployment of the MoMo Payment Verification System to Render with Supabase as the database backend.\n\n## Prerequisites\n\n1. **Supabase Account**: Sign up at [supabase.com](https://supabase.com)\n2. **Render Account**: Sign up at [render.com](https://render.com)\n3. **GitHub Repository**: Your code should be in a GitHub repository\n4. **Android SMS Forwarder App**: For forwarding SMS messages to your backend\n\n## Step 1: Set up Supabase Database\n\n### 1.1 Create a New Supabase Project\n\n1. Go to [supabase.com](https://supabase.com) and create a new project\n2. Choose a project name (e.g., \"momo-payment-verification\")\n3. Set a strong database password\n4. Select a region close to your users (preferably in Africa)\n\n### 1.2 Run Database Schema\n\n1. Go to the SQL Editor in your Supabase dashboard\n2. Copy and paste the entire contents of `database/supabase_schema.sql`\n3. Click \"Run\" to create all tables and functions\n4. Verify that the following tables were created:\n   - `transactions`\n   - `verification_codes`\n   - `payment_verifications`\n   - `fraud_alerts`\n   - `sms_processing_logs`\n\n### 1.3 Get Supabase Credentials\n\n1. Go to Settings → API in your Supabase dashboard\n2. Copy the following:\n   - **Project URL** (looks like: `https://your-project-id.supabase.co`)\n   - **anon/public key** (starts with `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`)\n   - **service_role key** (for admin operations, optional)\n\n## Step 2: Deploy to Render\n\n### 2.1 Connect GitHub Repository\n\n1. Go to [render.com](https://render.com) and log in\n2. Click \"New\" → \"Web Service\"\n3. Connect your GitHub repository containing this project\n4. Select the repository and branch (usually `main`)\n\n### 2.2 Configure Web Service\n\n**Basic Settings:**\n- **Name**: `momo-payment-verification`\n- **Region**: Choose closest to your users\n- **Branch**: `main`\n- **Runtime**: `Python 3`\n- **Build Command**: `pip install -r requirements.txt`\n- **Start Command**: `gunicorn --bind 0.0.0.0:$PORT app:app --workers 2 --timeout 120`\n\n**Environment Variables:**\nAdd the following environment variables in Render:\n\n```\nFLASK_ENV=production\nFLASK_SECRET_KEY=your-super-secret-key-generate-a-new-one\nSUPABASE_URL=https://your-project-id.supabase.co\nSUPABASE_ANON_KEY=your-supabase-anon-key-from-step-1.3\nDEFAULT_VERIFICATION_CODE=1043577\nFRAUD_DETECTION_ENABLED=true\nLOG_LEVEL=INFO\n```\n\n**Advanced Settings:**\n- **Health Check Path**: `/api/health`\n- **Auto-Deploy**: Yes\n\n### 2.3 Deploy\n\n1. Click \"Create Web Service\"\n2. Wait for the deployment to complete (5-10 minutes)\n3. Once deployed, you'll get a URL like: `https://momo-payment-verification.onrender.com`\n\n## Step 3: Test the Deployment\n\n### 3.1 Health Check\n\nVisit: `https://your-app-url.onrender.com/api/health`\n\nYou should see:\n```json\n{\n  \"status\": \"healthy\",\n  \"timestamp\": \"2025-01-15T20:00:00Z\",\n  \"services\": {\n    \"supabase\": true,\n    \"sms_parser\": true,\n    \"fraud_detector\": true,\n    \"txid_matcher\": true\n  }\n}\n```\n\n### 3.2 Test Payment Verification Page\n\nVisit: `https://your-app-url.onrender.com/`\n\nYou should see the beautiful payment verification interface with verification code **1043577**.\n\n### 3.3 Test SMS Processing (Optional)\n\nUse a tool like Postman or curl to test SMS processing:\n\n```bash\ncurl -X POST https://your-app-url.onrender.com/api/sms/process \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"message\": \"TxId: 22004556853. Your payment of 1,100 RWF to Test Merchant has been completed at 2025-01-15 20:00:00. Your new balance: 50,000 RWF. Fee was 0 RWF.\",\n    \"sender\": \"MTN\",\n    \"timestamp\": \"2025-01-15T20:00:00Z\"\n  }'\n```\n\n## Step 4: Set up SMS Forwarding\n\n### 4.1 Android SMS Forwarder App\n\n1. Install an SMS forwarding app on your Android phone (e.g., \"SMS to URL Forwarder\")\n2. Configure it to forward SMS messages from MTN Mobile Money to your webhook\n3. Set the webhook URL to: `https://your-app-url.onrender.com/api/sms/process`\n4. Set the format to JSON with fields:\n   - `message`: SMS content\n   - `sender`: Sender number/name\n   - `timestamp`: ISO timestamp\n\n### 4.2 Test SMS Forwarding\n\n1. Make a test MoMo payment\n2. Wait for the SMS\n3. Check if it appears in your Supabase `transactions` table\n4. Try verifying the payment on your web interface\n\n## Step 5: Production Configuration\n\n### 5.1 Security Headers\n\nRender automatically applies security headers from `render.yaml`. These include:\n- X-Frame-Options: DENY\n- X-Content-Type-Options: nosniff\n- Strict referrer policy\n\n### 5.2 Rate Limiting\n\nConsider adding rate limiting for production:\n- Max 60 verification requests per minute per IP\n- Max 120 SMS processing requests per minute\n\n### 5.3 Monitoring\n\n1. Use Render's built-in logs and metrics\n2. Set up alerts for:\n   - High error rates\n   - SMS processing failures\n   - Database connection issues\n\n### 5.4 Backup Strategy\n\n1. Enable Supabase automatic backups\n2. Consider exporting critical transaction data regularly\n3. Test disaster recovery procedures\n\n## Step 6: Custom Domain (Optional)\n\n### 6.1 Add Custom Domain\n\n1. In Render dashboard, go to your service settings\n2. Click \"Custom Domains\"\n3. Add your domain (e.g., `payments.yourbusiness.com`)\n4. Update DNS records as instructed by Render\n5. SSL will be automatically provisioned\n\n### 6.2 Update SMS Forwarder\n\nUpdate your SMS forwarder app to use your custom domain instead of the Render URL.\n\n## Troubleshooting\n\n### Common Issues\n\n1. **\"Supabase client not available\"**\n   - Check that SUPABASE_URL and SUPABASE_ANON_KEY are set correctly\n   - Verify the Supabase project is active\n\n2. **SMS parsing failures**\n   - Check the raw SMS format in the logs\n   - Update parsing patterns if MTN changes SMS format\n\n3. **Verification fails**\n   - Ensure transactions are being stored in the database\n   - Check the time window (48 hours by default)\n   - Verify TxID format matches expectations\n\n4. **Performance issues**\n   - Monitor Render metrics\n   - Consider upgrading from free tier\n   - Optimize database queries\n\n### Logs and Debugging\n\n1. View logs in Render dashboard → Service → Logs\n2. Check Supabase dashboard for database errors\n3. Use `/api/stats` endpoint to monitor system health\n\n## Maintenance\n\n### Regular Tasks\n\n1. **Weekly**: Review error logs and transaction success rates\n2. **Monthly**: Clean up old transaction data (older than 90 days)\n3. **Quarterly**: Review and update fraud detection rules\n4. **As needed**: Update SMS parsing patterns for new message formats\n\n### Updates and Deployments\n\n1. Test changes locally first\n2. Deploy to a staging environment if possible\n3. Use Render's automatic deployments from GitHub\n4. Monitor logs after each deployment\n\n## Support and Maintenance\n\nFor issues and updates:\n1. Check the application logs first\n2. Review this deployment guide\n3. Test individual components (SMS parsing, database, fraud detection)\n4. Consider creating a staging environment for testing changes\n\n---\n\n**Important Security Notes:**\n- Never commit `.env` files with real credentials\n- Regularly rotate API keys and secrets\n- Monitor for unusual activity patterns\n- Keep dependencies updated\n- Use strong, unique passwords for all services\n\n**Performance Optimization:**\n- Monitor response times and database query performance\n- Consider implementing caching for frequently accessed data\n- Optimize SMS parsing patterns for better performance\n- Use database indexes effectively
